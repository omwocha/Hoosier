<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hoosier Camp Meeting App - Login</title>
  <link rel="stylesheet" href="css/styles.css">
  <script defer src="/__/firebase/12.7.0/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/12.7.0/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/12.7.0/firebase-firestore-compat.js"></script>
  <script defer src="js/firebase-init.js"></script>
  <script defer src="js/auth.js"></script>
  <script defer src="js/cookie-consent.js"></script>
</head>
<body class="login-page">
  <header class="topbar minimal">
    <div class="brand">
      <div class="brand-mark">HCM</div>
      <div class="brand-text">
        <div class="brand-title">Hoosier Camp Meeting</div>
        <div class="brand-subtitle">Board Demo</div>
      </div>
    </div>
    <nav class="nav">
      <a class="nav-link" href="/index.html">Back to site</a>
    </nav>
  </header>

  <main class="auth-shell">
    <div class="auth-card card">
      <p class="eyebrow">Board Demo - Sign In</p>
      <h1>Hoosier Camp Meeting App</h1>
      <p class="muted">Sign in with email/password or Google. First login creates an attendee profile.</p>

      <div id="authMessage" class="auth-message" role="alert" aria-live="polite"></div>

      <form id="loginForm" class="stack small">
        <label>Email<input type="email" name="email" required autocomplete="username"></label>
        <label>Password<input type="password" name="password" required autocomplete="current-password"></label>
        <button class="button primary" type="submit" id="loginBtn">Sign In</button>
        <button class="button ghost" type="button" id="resetBtn">Forgot Password</button>
      </form>

      <div class="auth-divider">or</div>

      <button class="button google" type="button" id="googleBtn">
        <span class="google-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.64 9.2045c0-.6381-.0573-1.2518-.1636-1.8409H9v3.4818h4.8441c-.2087 1.125-.8431 2.0786-1.7977 2.7168v2.2581h2.9087c1.7027-1.5681 2.684-3.8809 2.684-6.6158z" fill="#4285F4"/>
            <path d="M9 18c2.43 0 4.4682-.8063 5.9573-2.1809l-2.9087-2.2581c-.8063.54-1.8373.859-3.0486.859-2.3477 0-4.334-1.584-5.0446-3.7136H.9573v2.3318C2.4382 15.9831 5.4818 18 9 18z" fill="#34A853"/>
            <path d="M3.9554 10.7064C3.7727 10.1664 3.6818 9.5932 3.6818 9s.0909-1.1664.2736-1.7064V4.9618H.9573C.3477 6.1732 0 7.5436 0 9s.3477 2.8268.9573 4.0382l2.9981-2.3318z" fill="#FBBC05"/>
            <path d="M9 3.5795c1.3214 0 2.5086.4545 3.4418 1.3455l2.5814-2.5814C13.464 1.0059 11.426 0 9 0 5.4818 0 2.4382 2.0168.9573 4.9618L3.9554 7.2936C4.666 5.1632 6.6523 3.5795 9 3.5795z" fill="#EA4335"/>
          </svg>
        </span>
        <span>Sign in with Google</span>
      </button>

      <p class="auth-note">By continuing, you agree to the <a href="/terms.html">Terms of Use</a> and acknowledge the <a href="/privacy.html">Privacy Policy</a>.</p>

      <div class="auth-divider">New here?</div>

      <form id="registerForm" class="stack small">
        <label>Full Name<input type="text" name="fullName" required autocomplete="name"></label>
        <label>Email<input type="email" name="email" required autocomplete="email"></label>
        <label>Password<input type="password" name="password" required autocomplete="new-password" minlength="6"></label>
        <label class="inline legal-check">
          <input type="checkbox" name="agreeTerms" required>
          <span>I agree to the <a href="/terms.html">Terms of Use</a> and <a href="/privacy.html">Privacy Policy</a>.</span>
        </label>
        <button class="button primary" type="submit" id="registerBtn">Create Account</button>
      </form>
    </div>
  </main>

  <footer class="footer minimal">
    <div>Hoosier Camp Meeting - Demo only - Firebase Hosting</div>
    <div class="muted small">Cookies: manage via banner or footer on main site.</div>
    <div class="muted small"><a href="/terms.html">Terms of Use</a> · <a href="/privacy.html">Privacy Policy</a></div>
  </footer>

  <script>
    (function() {
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const googleBtn = document.getElementById('googleBtn');
      const resetBtn = document.getElementById('resetBtn');
      const messageBox = document.getElementById('authMessage');
      const auth = firebase.auth();

      function setMessage(text, isError) {
        messageBox.textContent = text || '';
        messageBox.className = 'auth-message' + (isError ? ' error' : '');
      }

      function setLoading(isLoading) {
        [loginForm, registerForm, googleBtn, resetBtn].forEach((el) => {
          if (!el) return;
          el.querySelectorAll ? el.querySelectorAll('button, input').forEach((i) => i.disabled = isLoading) : el.disabled = isLoading;
        });
      }

      loginForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = new FormData(loginForm);
        setLoading(true);
        setMessage('Signing in...');
        try {
          await HCMAuth.signInWithEmail(data.get('email'), data.get('password'));
        } catch (err) {
          setMessage(err.message || 'Sign in failed', true);
          setLoading(false);
        }
      });

      registerForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = new FormData(registerForm);
        setLoading(true);
        setMessage('Creating account...');
        try {
          await HCMAuth.registerWithEmail(data.get('email'), data.get('password'), data.get('fullName'));
        } catch (err) {
          setMessage(err.message || 'Registration failed', true);
          setLoading(false);
        }
      });

      googleBtn?.addEventListener('click', async () => {
        setLoading(true);
        setMessage('Opening Google Sign-In...');
        try {
          await HCMAuth.signInWithGoogle();
        } catch (err) {
          setMessage(err.message || 'Google Sign-In failed', true);
          setLoading(false);
        }
      });

      resetBtn?.addEventListener('click', async () => {
        const email = prompt('Enter your email to reset password:');
        if (!email) return;
        setLoading(true);
        setMessage('Sending reset email...');
        try {
          await HCMAuth.sendPasswordReset(email);
          setMessage('Password reset email sent.');
        } catch (err) {
          setMessage(err.message || 'Reset failed', true);
        } finally {
          setLoading(false);
        }
      });

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          setLoading(true);
          setMessage('Signing you in...');
          const provider = user.providerData?.[0]?.providerId || 'password';
          try {
            await HCMAuth.ensureUserDocument(user, provider);
          } catch (e) {
            console.warn('Unable to ensure profile', e);
          }
          HCMAuth.redirectAfterLogin(HCMAuth.getReturnUrl());
        }
      });
    })();
  </script>
</body>
</html>
